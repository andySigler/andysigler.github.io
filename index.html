<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="js/seed.js"></script>
		<script type="text/javascript" src="js/branch.js"></script>
		<script type="text/javascript" src="js/tree.js"></script>
		<style>
			body{
				margin:0px 0px 0px 0px;
				background-color: #ffffff;
				font-family: "Lucida Console", Monaco, monospace;
			}
			.text{
				width:500px;
				margin-left: auto;
				margin-right: auto;
				text-align: center;
				margin-top: 10%;
				display:block;
				color:#888888;
			}
			#seeds{
				position:absolute;
				left:0px;
				top:0px;
			}

			.canvas{
				position:absolute;
				top:0px;
			}
			h1{
				font-size: 100px;
				line-height: 10px;
				display:block;
			}
			h2{
				font-size: 50px;
				line-height: 10px;
				display:block;
			}

		</style>
	</head>
	<body>
		<div id="forest"></div>
		<div id="text" class="text">
			<h3>Tap to Plant a Seed</h3>
		</div>
		<canvas id="seeds"></canvas>
		<script type="text/javascript">

			/////////////////////////////////////////////
			/////////////////////////////////////////////
			/////////////////////////////////////////////

			function makeWind(elm){

				var animation = false;
				var animationstring = 'animation';
				var keyframeprefix = '';
				var domPrefixes = 'Webkit Moz O ms Khtml'.split(' ');
				var pfx  = '';

				if( elm.style.animationName ) { 
					animation = true;
				}    

				if( animation === false ) {
					for( var i = 0; i < domPrefixes.length; i++ ) {
						if( elm.style[ domPrefixes[i] + 'AnimationName' ] !== undefined ) {
							pfx = domPrefixes[ i ];
							animationstring = pfx + 'Animation';
							keyframeprefix = '-' + pfx.toLowerCase() + '-';
							animation = true;
							break;
						}
					}
				}

				if( animation  ) {
					var moveAmount = Math.round(window.innerWidth*.015);
					var time  = Math.round(Math.random()*6)+3;
					elm.style[ animationstring ] = 'wind '+time+'s ease-in-out infinite alternate';

					var keyframes = '@' + keyframeprefix + 'keyframes wind { '+
					'from {' + keyframeprefix + 'transform:matrix(1, 0, -0.05, 1,  '+moveAmount+', 0) }'+
					'to {' + keyframeprefix + 'transform:matrix(1, 0, 0.05, 1,  '+-moveAmount+', 0) }'+
					'}';

					if( document.styleSheets && document.styleSheets.length ) {

						document.styleSheets[0].insertRule( keyframes, 0 );
					}
					else {

						var s = document.createElement( 'style' );
						s.innerHTML = keyframes;
						document.getElementsByTagName( 'head' )[ 0 ].appendChild( s );

					}
				}
			}

			/////////////////////////////////////////////
			/////////////////////////////////////////////
			/////////////////////////////////////////////

			var v = [
				{
					'size':110,
					'step':-2,
					'splitRad':60,
					'splitProb':.02,
					'splitAngle':.1,
					'leafProb':.2,
					'wiggle':.1,
					'feedback':0.985
				},
				{
					'size':30,
					'step':-2.3,
					'splitRad':20,
					'splitProb':.035,
					'splitAngle':.15,
					'leafProb':.3,
					'wiggle':.15,
					'feedback':0.985
				},
				{
					'size':140,
					'step':-1.8,
					'splitRad':70,
					'splitProb':.02,
					'splitAngle':.2,
					'leafProb':.1,
					'wiggle':.05,
					'feedback':0.988
				},
				{
					'size':50,
					'step':-2.5,
					'splitRad':20,
					'splitProb':.03,
					'splitAngle':.05,
					'leafProb':.2,
					'wiggle':.17,
					'feedback':0.99
				},
				{
					'size':100,
					'step':-2.5,
					'splitRad':50,
					'splitProb':.05,
					'splitAngle':.1,
					'leafProb':.3,
					'wiggle':.17,
					'feedback':0.97
				}
			];

			/////////////////////////////////////////////
			/////////////////////////////////////////////
			/////////////////////////////////////////////

			var trees = [];

			function makeTree(_x){
				var t = new Tree(_x);
				trees.push(t);
			}

			/////////////////////////////////////////////
			/////////////////////////////////////////////
			/////////////////////////////////////////////

			var seeds = [];

			function makeSeed(_x,_y){
				var s = new Seed(_x,_y,seedImg.width,seedImg.height);
				seeds.push(s);
			}

			/////////////////////////////////////////////
			/////////////////////////////////////////////
			/////////////////////////////////////////////

			var seedImg;

			function loadSeed(){
				seedImg = document.createElement('img');
				seedImg.src = 'images/seed.png';
			}

			/////////////////////////////////////////////
			/////////////////////////////////////////////
			/////////////////////////////////////////////

			window.onload = init;

			var isMobile;

			function init(){
				isMobile = mobilecheck();
				loadSeed();
				initSeedCanvas();
				masterLoop();
			}

			function masterLoop(){

				var treeThresh = 10;

				for(var i=0;i<trees.length;i++){
					if(i+treeThresh<trees.length){
						trees[i].startFading = true;
					}
					trees[i].update();
					if(trees[i].ready2delete){
						trees.splice(i,1);
						i--;
					}
				}
				
				if(seeds.length>0){
					seedContext.clearRect(0,0,seedCanvas.width,seedCanvas.height);
					for(var i=0;i<seeds.length;i++){
						seeds[i].update();
						seeds[i].paint();
						if(seeds[i].done){
							makeTree(seeds[i].x);
							seeds.splice(i,1);
							i--;
						}
					}
				}
				requestAnimFrame(masterLoop);
			}

			/////////////////////////////////////////////
			/////////////////////////////////////////////
			/////////////////////////////////////////////

			var mobilecheck = function() {
                var check = false;
                (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))check = true})(navigator.userAgent||navigator.vendor||window.opera);
                return check;
            }

			/////////////////////////////////////////////
			/////////////////////////////////////////////
			/////////////////////////////////////////////

			window.onresize = function(e){
				if(!isMobile){
					for(var i=0;i<trees.length;i++){
						trees[i].canvas.parentNode.removeChild(trees[i].canvas);
					}
					trees = [];
					initSeedCanvas();
				}
			}

			window.onorientationchange = function(e){
				if(isMobile){
					var cans = document.getElementById('forest').children;
					for(var i=0;i<cans.length;i++){
						document.getElementById('forest').removeChild(cans[i]);
					}
					trees = [];
					initSeedCanvas();
				}
			}

			/////////////////////////////////////////////
			/////////////////////////////////////////////
			/////////////////////////////////////////////
			
			var seedCanvas;
			var seedContext;

			function initSeedCanvas(){
				seedCanvas = document.getElementById('seeds');
				seedCanvas.width = window.innerWidth;
				seedCanvas.height = window.innerHeight;
				seedContext = seedCanvas.getContext('2d');
				seedCanvas.onclick = function(e){
					if(e.x && e.y){
						makeSeed(e.x,e.y);
					}
					else if(e.clientX && e.clientY){
						makeSeed(e.clientX,e.clientY);
					}
				}
				seedCanvas.ontouchstart = function(e){
					if(e.x && e.y){
						makeSeed(e.x,e.y);
					}
					else if(e.screenX && e.screenY){
						makeSeed(e.screenX,e.screenY);
					}
				}
			}

			/////////////////////////////////////////////
			/////////////////////////////////////////////
			/////////////////////////////////////////////

			window.requestAnimFrame = (function(){
				return  window.requestAnimationFrame       ||
				window.webkitRequestAnimationFrame ||
				window.mozRequestAnimationFrame    ||
				function( callback ){
					window.setTimeout(callback, 1000 / 60);
				};
			})();

			/////////////////////////////////////////////
			/////////////////////////////////////////////
			/////////////////////////////////////////////

		</script>
	</body>
</html>
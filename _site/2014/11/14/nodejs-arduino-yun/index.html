<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <!-- <link href="http://gmpg.org/xfn/11" rel="profile"> -->

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      NodeJS + Yun &middot; andysigler
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/main.css"> <!-- custom CSS -->

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/atom+xml" title="andysigler" href="/atom.xml">
  <script type="text/javascript">

    var pallette = [
      {
        color : '#355C69',
        kids: [],
      },
      {
        color : '#646881',
        kids: [],
      },
      {
        color : '#69355C',
        kids: [],
      }
      
    ];

    var extraColors = ['#DDB967','#D1603D','#272932'];
  </script>
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <div class="content-centered">
          <a href="/" title="Home">
            <h3 class="masthead-title" style="text-decoration: none;">
              <small>making useless things</small>
              <br />
              andysigler
            </h3>
          </a>
        </div>
      </header>

      <main>
        <article class="post">
  <!-- <div class="post-header" style="background-image:url(/public/images/nodejs_arduino.jpg);"> -->
  <div class="post-header">
    <div class="post-title-box">
      <div class="verticalAlign">
        <h1 class="post-title">
          <span>
            NodeJS + Yun
          </span>
        </h1>
        <h3 class="post-subtitle">
          <span class="post-text">
            Installing and Running NodeJS on the Arduino Yun
          </span>
        </h1>
        <time datetime="2014-11-14T00:00:00-05:00" class="page-date">
          <span class="post-text">
            14 Nov 2014
          </span>
        </time>
      </div>
    </div>
  </div>
  <div class="block"><div class="content-centered">

    <h2 id="before-you-begin">Before you begin</h2>

    <p>Below are the steps to get NodeJS up and running on the Arduino Yun. This tutorial assumes you have already connected the Yun to your network, and have a basic understanding of NodeJS.</p>

    <p>The final steps (red section) of this tutorial are optional and should be taken with caution. They show how to disable Bridge on the Yun, in order to allow NodeJS to speak directly with the Arduino side of the board using node-serialport.</p>

    <p>This, however, means you can only access the Linux side of the board over the network. If you do not have control over the network between your computer and Yun, you will not be able to connect.</p>

  </div></div>
<div class="block"><div class="content-centered">

    <h2 id="update-and-expand-your-yun">Update and Expand your Yun</h2>

    <h3 id="update-the-yuns-image">Update the Yun’s image</h3>

    <p>To do all the following, make sure you have updated your Yun to the latest image. This to to allow your Yun to have is disk space expanded in the next step.</p>

    <p><a href="http://arduino.cc/en/Tutorial/YunSysupgrade" class="inpost-link" target="_blank">Instructions on updating the Yun’s image</a></p>

    <h3 id="expand-disk-space-with-sd-card">Expand disk space with SD card</h3>

    <p>We will be moving the Yun’s operating system and memory onto a micro-sd card, so that we have enough room to install and run NodeJS.</p>

    <p><a href="http://arduino.cc/en/Tutorial/ExpandingYunDiskSpace" class="inpost-link" target="_blank">Instructions on expanding the Yun’s disk space</a></p>

  </div></div>
<div class="block"><div class="content-centered">

    <h2 id="install-nodejs-and-sftp">Install NodeJS and SFTP</h2>

    <h3 id="install-node-and-node-modules-with-opkg">Install Node and node-modules with opkg</h3>

    <p>With an updated Yun image and more memory, we can install Node using opkg (the Yun’s package management system). Be sure the Yun is connected to the internet.</p>

    <p>Enter the following line into the Yun to prepare opkg.</p>

    <div class="highlight"><pre><code class="language-html" data-lang="html">opkg update</code></pre></div>

    <p>After each call to opkg, you should see some lines about downloading and installing some files.</p>

    <p>Next install NodeJS with the following line.</p>

    <div class="highlight"><pre><code class="language-html" data-lang="html">opkg install node</code></pre></div>

    <p>This may take a few moments. After it’s finished, install the pre-compiled node-modules using opkg.</p>

    <div class="highlight"><pre><code class="language-html" data-lang="html">opkg install node-ws 
opkg install node-serialport</code></pre></div>

    <p>There are a few other pre-compiled node-modules you can install through opkg. All modules are installed globally, so there is no need to ever run npm (especially because npm doesn’t work on the Yun…)</p>

    <h3 id="add-sftp-to-transfer-files">Add SFTP to transfer files</h3>

    <p>Uploading files to the Yun is much faster if you don’t have to turn it off every time. To do this, we have enable our Yun to be accessed over SFTP. Now, applications like CyberDuck can connect to and upload files to your Yun</p>

    <p>Enter the following line to install the SFTP package, and now you can connect to it using an FTP client like CyberDuck.</p>

    <div class="highlight"><pre><code class="language-html" data-lang="html">opkg update 
opkg install openssh-sftp-server</code></pre></div>

    <p>In CyberDuck, connect with SFTP, port 22, username ‘root’, and the server-name being your Yun’s IP address.</p>

    <p><img src="/public/images/cyberDuck_yun.png" alt="cyberDuck_yun" /></p>

    <p>I store all the node and web files on the micro-sd card, at <code>/mnt/sda1/arduino/node</code>. “sda1” is the external memory, “arduino” is a folder that should already exist, and “node” is a folder I created to store my Node scripts.</p>

    <p><img src="/public/images/cyberDuck_yun_2.png" alt="cyberDuck_yun_2" /></p>

    <p>Now you can upload and run NodeJS scripts on your Yun! See the below link for you can get NodeJS and the Arduino side of the Yun talking with Bridge:</p>

    <p><a href="http://www.tigoe.com/pcomp/code/arduinowiring/1216/#more-1216" class="inpost-link" target="_blank">Node.js on the Arduino Yun</a> - Tom Igoe’s example for getting NodeJS and the ATmega32U4 to communicate with Bridge.</p>

  </div></div>
<div class="block"><div class="content-centered">

    <h2 id="make-the-yun-unabridged">Make the Yun Unabridged</h2>

    <h3 id="give-the-ethernet-port-a-static-ip">Give the ethernet port a static IP</h3>

    <p>To my mind, the biggest disadvantage of removing Bridge from the Yun, is that you are taking away the ability to access the Linino through the ATmega32U4. This is especially helpul during initial setup, and while configuring the Yun’s network.</p>

    <p>To give some added security, I have chosen to give my Yun’s ethernet port a static, never changing IP address. With this, I can ssh into the Yun over an ethernet cable, using the following steps.</p>

    <p>We will edit a file to change the Yun’s network settings. The nano command opens it in terminal:</p>

    <div class="highlight"><pre><code class="language-html" data-lang="html">nano /etc/config/network</code></pre></div>

    <p>If you get the error <code>Error opening terminal: xterm-256color.</code>, the following worked for me.</p>

    <div class="highlight"><pre><code class="language-html" data-lang="html">ln -s x /usr/share/terminfo/78 
export TERM=xterm-color 
nano /etc/config/network</code></pre></div>

    <p>Find the part of the document that looks like this:</p>

    <div class="highlight"><pre><code class="language-html" data-lang="html">config interface &#39;wan&#39;
   option iframe &#39;eth1&#39;
   option proto &#39;dhcp&#39;
   option metric &#39;10&#39;</code></pre></div>

    <p>And change it to look like this:</p>

    <div class="highlight"><pre><code class="language-html" data-lang="html">config interface &#39;wan&#39;
   option iframe &#39;eth1&#39;
   option &#39;proto&#39; &#39;static&#39;
   option &#39;ipaddr&#39; &#39;192.168.0.200&#39;
   option &#39;netmask&#39; &#39;255.255.255.0&#39;
   option &#39;gateway&#39; &#39;192.168.0.1&#39;
   option &#39;dns&#39; &#39;192.168.0.1&#39;
   option metric &#39;10&#39;</code></pre></div>

    <p>Instructions on the bottom show how to Write Out (save the file), and Exit.</p>

    <p>To Write Out (save your changes), hit <code>CONTROL-O</code>. It will ask if you want to save changes to this file, hit <code>ENTER</code> to save. To Exit hit <code>CONTROL-X</code>.</p>

    <p>Restart your Yun, and you will find it’s ethernet port has the permanent address <code>192.168.0.200</code>.</p>

    <p>In order to ssh into the Yun over an ethernet cable, your laptop’s ethernet IP address must share the same two first digits as the Yun’s IP. In this example, the laptop’s IP should beging width 192 and 168 in order for the two to communicate.</p>

    <p><img src="/public/images/staticEthernet_mac.png" alt="staticEthernet_mac" /></p>

    <p>On a Mac, I can go to <code>System Preferences &gt; Network</code>, select the ethernet port, and tell it to be a Manual IP Address (not DHCP). For example, I could set my laptop to be <code>192.168.0.42</code>.</p>

  </div></div>
<div class="block"><div class="content-centered">

    <h2 id="disable-bridge-on-the-yun">Disable Bridge on the Yun</h2>

    <p class="message">
Warning: Proceed with Caution!
To disable Bridge and free the serial port between the Linux processor and the ATmega32U4, you simply have to comment out one line, and then restart the Yun. To bring Bridge back, simply uncomment the line, and restart the Yun.
</p>

    <p>Open the file we must in edit in Terminal with the following command.</p>

    <div class="highlight"><pre><code class="language-html" data-lang="html">nano /etc/inittab</code></pre></div>

    <p>If you get the error <code>Error opening terminal: xterm-256color.</code>, the following worked for me.</p>

    <div class="highlight"><pre><code class="language-html" data-lang="html">ln -s x /usr/share/terminfo/78 
export TERM=xterm-color 
nano /etc/inittab</code></pre></div>

    <p>The nano command will open up a text editor in Terminal, where you can move around with the arrow keys.</p>

    <p>Find the line that says this:</p>

    <div class="highlight"><pre><code class="language-html" data-lang="html">ttyATH0::askfirst:/bin/ash --login</code></pre></div>

    <p>And comment it out with pound sign at the beginning, like this:</p>

    <div class="highlight"><pre><code class="language-html" data-lang="html">#ttyATH0::askfirst:/bin/ash --login</code></pre></div>

    <p>Instructions on the bottom show how to Write Out (save the file), and Exit.</p>

    <p>To Write Out (save your changes), hit <code>CONTROL-O</code>. It will ask if you want to save changes to this file, hit <code>ENTER</code> to save. To Exit hit <code>CONTROL-X</code>.</p>

    <p>Restart your Yun, and Bridge will not run. Once again, simply uncomment the line to bring Bridge back.</p>

  </div></div>
<div class="block"><div class="content-centered">

    <h2 id="using-the-new-setup">Using the new setup</h2>

    <h3 id="modify-code-and-run">Modify code and run</h3>

    <p>The Arduino on your Yun can now open a plain Serial connection to the Linux processor. However, it uses <code>Serial1</code> instead of <code>Serial</code>. <code>Serial</code> (without the 1) is connected to the micro-USB, and is used to upload code and communicate with a laptop.</p>

    <p>So to begin in your setup(), your Arduino code should read:</p>

    <div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="n">Serial1</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span> 
<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">Serial1</span><span class="p">){}</span></code></pre></div>

    <p>And to read and write, continue using <code>Serial1</code>:</p>

    <div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="k">while</span><span class="p">(</span><span class="n">Serial1</span><span class="p">.</span><span class="n">available</span><span class="p">()){</span>
   <span class="n">Serial1</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">Serial1</span><span class="p">.</span><span class="n">read</span><span class="p">());</span>
<span class="p">}</span>
<span class="n">Serial1</span><span class="p">.</span><span class="n">println</span><span class="p">();</span></code></pre></div>

    <p>Any process running on Linux side of the board can access the Arduino’s serial port with the name <code>/dev/ttyATH0</code>.</p>

    <p>Now any NodeJS script using the node-serialport module can access the Atmel32u4 using port <code>/dev/ttyATH0</code>.</p>

    <h3 id="resources">Resources</h3>

    <p><a href="https://github.com/andySigler/NodeJS_Yun_Example" class="inpost-link" target="_blank">NodeJS_Yun_Example</a> - Some example code, showing a NodeJS server mediating the connection between a browser and an Arduino.</p>

    <p><a href="https://github.com/voodootikigod/node-serialport/blob/master/README.md" class="inpost-link" target="_blank">Reference for node-serialport</a> - Connect a Node script to the ATmega32U4</p>

    <p><a href="https://github.com/einaros/ws/blob/master/README.md" class="inpost-link" target="_blank">Reference for node-ws</a> - Run a WebSocket server on the Yun to have fast, real-time communication with a browser or other devices.</p>

    <p><a href="https://github.com/arduino/openwrt-packages-yun/tree/master/arduino" class="inpost-link" target="_blank">Node-modules available through opkg</a> - the repo containing all pre-compiled node-modules for the Yun. Others include Noble, Bleno, and socket.io.</p>

    <p><a href="http://www.tigoe.com/pcomp/code/arduinowiring/1216/#more-1216" class="inpost-link" target="_blank">Node.js on the Arduino Yun</a> - Tom Igoe’s example for getting NodeJS and the ATmega32U4 to communicate with Bridge. Its a bit of a hack that uses the stdin and stdout of a process.</p>

  </div>








</div>

</article>

<aside class="related content-centered">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2014/12/26/patchbay-interface/">
            The Patchbay Interface
            <small>
              <time datetime="2014-12-26T00:00:00-05:00">26 Dec 2014</time></small>
          </a>
        </h3>
      </li>
    
  </ul>
</aside>

      </main>

      <footer class="footer content-centered">
        <small>
          andrewsigler1@gmail.com
        </small>
        <!-- <small>
          &copy; <time datetime="2015-01-03T17:30:22-05:00">2015</time>. All rights reserved.
        </small> -->
      </footer>
    </div>
    <script type="text/javascript">
    window.addEventListener('load',function(){
      var blocks = document.getElementsByClassName('block');
      for(var i=0;i<blocks.length;i++){

        var stepAmount = 155/blocks.length;

        var palletteIndex = i%pallette.length
        var color = pallette[palletteIndex].color;

        //var color = 255-Math.floor(stepAmount*i);

       //blocks[i].style.backgroundColor = color;
      }
    });
  </script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-57970756-2', 'auto');
    ga('send', 'pageview');

  </script>

   <script type="text/javascript">

    // find all .block classes and alternate their background-colors
    var blocks = document.getElementsByClassName('block');
    for(var i=0;i<blocks.length;i++) {
      var b = blocks[i];
      if (i%2===1) {
        b.style.backgroundColor = 'rgb(79,79,79)';
        b.style.color = 'rgb(73,200,200)';
      }
      else {
        b.style.backgroundColor = 'white';
        b.style.color = 'black';
      }
    }
    if(blocks.length%2===1) {
      document.body.style.backgroundColor = 'rgb(79,79,79)';
      document.body.style.color = 'white';
    }
   </script>
  </body>
</html>
